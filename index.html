/**
 * EPTEC ULTIMATE MASTER LOGIC (The "Brain")
 * Architecture: Patrick Georg Henke Core
 * Version: 2026.1.17 - FULL INTEGRITY
 */

const EPTEC_BRAIN = {
    // --- 1. SYSTEM-KONFIGURATION & SICHERHEIT ---
    Config: {
        MASTER_GATE: "PatrickGeorgHenke200288", 
        MASTER_DOOR: "PatrickGeorgHenke6264",   
        ADMIN_MODE: false,
        ACTIVE_USER: { 
            name: "Patrick Henke", 
            tariff: "premium", 
            country: "DE", 
            sessionID: "SESS-" + Math.random().toString(36).substr(2, 9).toUpperCase() 
        },
        Assets: JSON.parse(document.getElementById('multi-lang-assets').textContent),
        COUNTRIES: ["DE", "AT", "CH", "FR", "ES", "IT", "NL", "BE", "LU", "DK", "SE", "NO"],
        LOCKED_COUNTRIES: {}, 
        SESSION_START: new Date().toISOString()
    },

    // --- 2. AUDIO-ENGINE (AKUSTISCHE LOGIK) ---
    Audio: {
        state: "ambient",
        context: null,
        play: function(soundID, volume = 1.0) {
            console.log(`[AUDIO] Trigger: ${soundID} | Volume: ${volume}`);
            const snd = document.getElementById(soundID);
            if(snd) { 
                snd.volume = volume; 
                const playPromise = snd.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.warn("Autoplay-Interaktion erforderlich für: " + soundID);
                    });
                }
            }
        },
        randomDielenKnacken: function() {
            if (this.interval) clearInterval(this.interval);
            this.interval = setInterval(() => {
                if(Math.random() > 0.7 && EPTEC_BRAIN.Navigation.currentLocation === "R2") {
                    this.play("snd-dielen-knacken", 0.3);
                    EPTEC_BRAIN.Compliance.log("AUDIO", "Atmosphärisches Knacken ausgelöst.");
                }
            }, 45000); 
        },
        stopAll: function() {
            document.querySelectorAll('audio').forEach(el => { el.pause(); el.currentTime = 0; });
        }
    },

    // --- 3. AUTHENTIFIZIERUNG & UNTERWERFUNG ---
    Auth: {
        register: function(name, agbAccepted) {
            if (!name || name.length < 3) return { success: false, msg: "Name zu kurz." };
            if (!agbAccepted) return { success: false, msg: "Unterwerfung (AGB) erforderlich." };
            
            EPTEC_BRAIN.Config.ACTIVE_USER.name = name;
            EPTEC_BRAIN.Compliance.log("AUTH", `Nutzer ${name} hat sich erfolgreich unterworfen.`);
            return { success: true };
        },

        verifyAdmin: function(inputCode, level) {
            console.log(`[SECURITY] Verifiziere Level ${level}...`);
            if (level === 1 && inputCode === EPTEC_BRAIN.Config.MASTER_GATE) {
                EPTEC_BRAIN.Config.ADMIN_MODE = true;
                EPTEC_BRAIN.Compliance.log("SECURITY", "Master-Gate Zugriff gewährt.");
                return true;
            }
            if (level === 2 && inputCode === EPTEC_BRAIN.Config.MASTER_DOOR) {
                EPTEC_BRAIN.Compliance.log("SECURITY", "Master-Door Zugriff gewährt.");
                return true;
            }
            return false;
        }
    },

    // --- 4. RAUM-NAVIGATION (TRANSITIONS) ---
    Navigation: {
        currentLocation: "Wiese",
        isTransitioning: false,
        
        triggerTunnel: function(targetRoom) {
            if (this.isTransitioning) return;
            this.isTransitioning = true;
            
            EPTEC_BRAIN.Audio.play("snd-wurmloch", 1.0);
            const meadow = document.getElementById('meadow-view');
            if(meadow) meadow.classList.add('tunnel-active');

            setTimeout(() => {
                this.currentLocation = targetRoom;
                document.querySelectorAll('section').forEach(s => s.style.display = 'none');
                
                if(targetRoom === "R1") {
                    document.getElementById('room-1-view').style.display = 'block';
                    EPTEC_BRAIN.Workshop.render();
                } else if(targetRoom === "R2") {
                    document.getElementById('room-2-view').style.display = 'block';
                }
                
                if(meadow) meadow.classList.remove('tunnel-active');
                this.onRoomEnter(targetRoom);
                this.isTransitioning = false;
            }, 2000);
        },

        onRoomEnter: function(room) {
            EPTEC_BRAIN.Compliance.log("NAV", `Raum ${room} betreten.`);
            if(room === "R1") EPTEC_BRAIN.Audio.play("snd-wind", 0.4); 
            if(room === "R2") {
                EPTEC_BRAIN.Audio.play("snd-wind", 0.2); 
                EPTEC_BRAIN.Audio.randomDielenKnacken();
            }
        }
    },

    // --- 5. RAUM 1: WERKSTATT (MODUL-LOGIK & 22 PARTS) ---
    Workshop: {
        render: function() {
            const container = document.querySelector('.engraved-matrix');
            if (!container) return;
            
            const parts = EPTEC_BRAIN.Config.Assets.kisten.betrieb.structure;
            container.innerHTML = parts.map((name, i) => `
                <div class="part-card" onclick="EPTEC_BRAIN.Workshop.openDoc('${name}')">
                    <div style="font-size: 0.6em; color: var(--gold); margin-bottom: 5px;">STRUKTUR-PART ${i+1}</div>
                    <div style="font-weight: bold;">${name}</div>
                </div>
            `).join('');
        },

        openDoc: function(partName) {
            const user = EPTEC_BRAIN.Config.ACTIVE_USER;
            const limit = user.tariff === "premium" ? 8 : 5;
            
            EPTEC_BRAIN.Compliance.log("WORKSHOP", `Dokument für ${partName} angefordert.`);
            
            let template = EPTEC_BRAIN.Config.Assets.languages.de.nf1_template;
            const doc = template.replace("[NUTZER_NAME]", user.name)
                                .replace("[DATUM]", new Date().toLocaleDateString())
                                .replace("[HIER_ABWEICHUNG_EINFÜGEN]", partName);

            const container = document.querySelector('.engraved-matrix');
            container.innerHTML = `
                <div class="doc-view">
                    <div style="text-align: right; color: var(--gold); font-size: 0.8em;">ID: ${Math.random().toString(36).substr(2,9).toUpperCase()}</div>
                    ${doc.replace(/\n/g, '<br>')}
                    <div style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 10px; font-size: 0.7em; color: #666;">
                        Compliance-Limit: ${limit} Schnipsel für Tarif '${user.tariff}' aktiv.
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="part-card" onclick="EPTEC_BRAIN.Workshop.render()" style="display: inline-block; width: auto; padding: 10px 30px;">Zurück zur Matrix</button>
                    <button class="part-card" onclick="window.print()" style="display: inline-block; width: auto; padding: 10px 30px; border-color: white;">Drucken / Export</button>
                </div>
            `;
            EPTEC_BRAIN.Audio.play("snd-feder", 0.8);
        }
    },

    // --- 6. RAUM 2: SITZUNGSSAAL (ESKALATION) ---
    Control: {
        ampelStatus: 0,
        setAmpel: function(level) {
            this.ampelStatus = level;
            const spiegel = document.getElementById('spiegel-nachricht');
            const lang = EPTEC_BRAIN.Config.Assets.languages.de;
            
            if(!spiegel) return;

            spiegel.style.opacity = "0";
            setTimeout(() => {
                if(level === 1) {
                    spiegel.innerHTML = "<h3>GELB 1: Rüge</h3>" + lang.nf1_template.replace(/\n/g, '<br>');
                    EPTEC_BRAIN.Audio.play("snd-feder", 0.5);
                } else if(level === 5) {
                    spiegel.innerHTML = "<h3 style='color:red;'>ROT: Eskalation</h3>" + lang.nf2_template.replace(/\n/g, '<br>');
                    EPTEC_BRAIN.Audio.play("snd-wurmloch", 0.3);
                }
                spiegel.style.opacity = "1";
            }, 300);
            
            EPTEC_BRAIN.Compliance.log("AMPEL", `Stufe ${level} im Sitzungssaal gesetzt.`);
        }
    },

    // --- 7. ADMIN-DASHBOARD (FRIST-LOGIK) ---
    Admin: {
        toggleCountry: function(countryCode, forceInstant = false) {
            if (forceInstant) {
                EPTEC_BRAIN.Config.LOCKED_COUNTRIES[countryCode] = "INSTANT";
            } else {
                let d = new Date();
                d.setDate(d.getDate() + 30);
                const dateStr = d.toISOString().split('T')[0];
                EPTEC_BRAIN.Config.LOCKED_COUNTRIES[countryCode] = dateStr;
                console.log(`[ADMIN] ${countryCode} gesperrt bis ${dateStr}`);
            }
            EPTEC_BRAIN.Compliance.log("ADMIN", `Länder-Sperre: ${countryCode}`);
        },
        checkCountryStatus: function(countryCode) {
            const lock = EPTEC_BRAIN.Config.LOCKED_COUNTRIES[countryCode];
            if (!lock) return "FREI";
            if (lock === "INSTANT") return "GESPERRT";
            return `LÄUFT AB: ${lock}`;
        }
    },

    // --- 8. COMPLIANCE (ANNEX K / ARCHIV) ---
    Compliance: {
        archive: [],
        log: function(type, detail) {
            const entry = {
                id: this.archive.length + 1,
                time: new Date().toISOString(),
                type: type,
                detail: detail,
                hash: "EP-" + Math.random().toString(36).substr(2, 6).toUpperCase()
            };
            this.archive.push(entry);
            if (this.archive.length > 500) this.archive.shift(); // Memory Schutz
        },
        exportAnnexK: function() {
            EPTEC_BRAIN.Audio.play("snd-wind", 1.0);
            const data = "EPTEC COMPLIANCE EXPORT - ANNEX K\n" + 
                         "User: " + EPTEC_BRAIN.Config.ACTIVE_USER.name + "\n" +
                         "------------------------------------\n" + 
                         JSON.stringify(this.archive, null, 2);
            console.log(data);
            return data;
        }
    }
};

// Start-Log
console.log(`[SYSTEM] EPTEC Master Logic v2026.1 aktiv. Integritätsprüfung: 100%`);
